var TeamSelection = angular.module('ivNet.Admin.TeamSelection', ['ngResource' ,'ui.bootstrap'])

TeamSelection.factory('configuration', function ($resource) {
    return $resource('/api/club/configuration/:id', null,
    {
        'query': { method: 'Get', isArray: true },
    });
});

TeamSelection.factory('fixture', function ($resource) {
    return $resource('/api/club/fixtures/:id', null,
    {
        'query': { method: 'Get', isArray: true }
    });
});

TeamSelection.factory('player', function ($resource) {
    return $resource('/api/club/player/:id', null,
    {
        'query': { method: 'Get', isArray: true }
    });
});

TeamSelection.controller('AdminTeamSelectionController', function ($scope, $filter, configuration, fixture, player) {

    $scope.playerSelected = function () {
        $scope.teamPlayers.push({ PlayerId: $scope.selectedPlayer.Id, Name: $scope.selectedPlayer.Name })
        $scope.selectedPlayer = null;
    }

    $scope.availablePlayerSelected = function () {
        $scope.teamPlayers.push({ PlayerId: this.availablePlayer.Id, Name: this.availablePlayer.Name })
    }
    
    //$scope.$watch('selectedPlayer', function (newValue, oldValue) {
    //    if (newValue)
    //        alert(oldValue + "->" + newValue);
    //});

    $scope.selectFixture = function () {
        $scope.selectedFixture = this.fixture;
        $('#loading-indicator').show();

        player.query({ type: 'available', date: $scope.selectedFixture.DatePlayed },
           function (data) {
               $scope.availablePlayers = data;
               $('#loading-indicator').hide();
               
           },
           function (error) {
               $('#loading-indicator').hide();
               alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
           });

        $('div.fixture-list').hide();
        $('div.fixture-detail').show();
        $('div.player-lists').show();
    }

    $scope.search = function() {
        $('#loading-indicator').show();

        fixture.query({ year: $scope.season, team: $scope.team },
            function(data) {
                $scope.fixtures = data;                

                $('#loading-indicator').hide();
                $('div.fixture-list').show();
            },
            function(error) {
                $('#loading-indicator').hide();
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });
    };

    init();

    function init() {
        $scope.season = "2015";
        $('div.fixture-list').hide();
        $('div.fixture-detail').hide();
        $('div.player-lists').hide();
        $scope.teamPlayers = [];
        
        configuration.query({ id: 'hometeam' },
            function(data) {
                $scope.teamList = data;
                $scope.team = $scope.teamList[0].Name;

                player.query({},
                    function (data) {
                        $scope.players = data;
                    },
                    function (error) {
                        $('#loading-indicator').hide();
                        alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
                    });
            },
            function (error) {
                $('#loading-indicator').hide();
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });
    };
});

TeamSelection.controller('HelpController', function ($scope) {
    $scope.showModal = false;
    $scope.toggleModal = function () {
        $scope.showModal = !$scope.showModal;
    };
});

TeamSelection.directive('modal', function () {
    return {
        template: '<div class="modal fade">' +
            '<div class="modal-dialog">' +
              '<div class="modal-content">' +
                '<div class="modal-header">' +
                  '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                  '<h4 class="modal-title">{{ title }}</h4>' +
                '</div>' +
                '<div class="modal-body" ng-transclude></div>' +
              '</div>' +
            '</div>' +
          '</div>',
        restrict: 'E',
        transclude: true,
        replace: true,
        scope: true,
        link: function postLink(scope, element, attrs) {
            scope.title = attrs.title;

            scope.$watch(attrs.visible, function (value) {
                if (value == true)
                    $(element).modal('show');
                else
                    $(element).modal('hide');
            });

            $(element).on('shown.bs.modal', function () {
                scope.$apply(function () {
                    scope.$parent[attrs.visible] = true;
                });
            });

            $(element).on('hidden.bs.modal', function () {
                scope.$apply(function () {
                    scope.$parent[attrs.visible] = false;
                });
            });
        }
    };
});