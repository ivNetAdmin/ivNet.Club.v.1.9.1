var Members = angular.module('ivNet.Members', ['ngResource', 'trNgGrid', 'ui.router'])
  
Members.factory('members', function ($resource) {
    return $resource('/api/club/members/:id', null,
    {
        'query': { method: 'Get', isArray: false },
        'update': { method: 'PUT' }
    });
});

Members.controller('MembersController', function ($scope, $filter, $window, members) {

    $scope.reload = function () {
        $window.location.reload();
    };

    $scope.addWard = function() {
        $scope.member.Wards.push({ MemberId: 0, Lastname: '', Firstname: '', Nickname: '', Dob: '' })
    };

    $scope.save = function () {
       
        var data = {
            Action: "edit",
            Type: "Member",
            Member: $scope.member
        };
        
        members.update({ id: $scope.member.MemberId }, data,
           function () {
               

           },
           function (error) {
               alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
           });
    };

    //$scope.checkWard = function () {
    //    $('#loading-indicator').show();
    //    $('div.user-message').hide();

    //    if ($scope.newDob == null || $scope.newLastname == null || $scope.newFirstname == null) {
    //        $scope.usermessage = "You must enter a first, last name and a date of birth";
    //        $('div.user-message').show();
    //        return;
    //    }

    //    var model = {
    //        Type: 'Ward',
    //        Lastname: $scope.newLastname,
    //        Firstname: $scope.newFirstname
    //    };

    //    member.check({ data: model },
    //        function (data) {

    //            $scope.newLastname = data.Lastname;
    //            $scope.newFirstname = data.Firstname;

    //            //if ($scope.newNickname != "") {
    //            //    $scope.newNickname = data.Nickname;
    //            //}
    //            //if (data.Dob != null) {
    //            //    $scope.newDob = data.Dob.substr(0, 10);
    //            //}

    //            if (data.MemberId > 0) {
    //                $scope.usermessage = "This member (" + data.Firstname + " " + data.Lastname + ") already has one or more guardians (" + data.GuardianList + "). If this is a new player make sure they have a unique firstname and lastname.";
    //                $('div.user-message').show();
    //            }

    //            if (checklist(data.MemberId)) {

    //                $scope.member.Wards.push({
    //                    MemberId: data.MemberId,
    //                    Firstname: $scope.newFirstname,
    //                    Lastname: $scope.newLastname,
    //                    Dob: $scope.newDob,
    //                    Nickname: $scope.newNickname
    //                })
    //            }

    //            $scope.newFirstname = null;
    //            $scope.newLastname = null;
    //            $scope.newDob = null;
    //            $scope.newNickname = null;

    //            $('#loading-indicator').hide();
    //        },
    //        function (error) {
    //            $('#loading-indicator').hide();
    //            alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
    //        });
    //};

    $scope.removeWard = function () {
        var item = this;
        var wardItemIndex = -1;
        $.each($scope.member.Wards, function (wardIndex, wardItem) {
            if (wardItem.MemberId == item.ward.MemberId) {
                wardItemIndex = wardIndex;
            }
        });

        var data = {
            Action: "deactivate",
            Type: "Player",
            GuardianId: item.ward.MemberId
        };

        members.update({ id: item.ward.MemberId }, data,
            function () {
                $scope.member.Wards.splice(wardItemIndex, 1);
            },
            function (error) {
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });
    };

    init();

    function init() {
           
        members.query({ id: 0 },
            function (data) {
                $scope.member = data;
                $scope.reset = data;

            },
            function (error) {
                $('#loading-indicator').hide();
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });

    };
});