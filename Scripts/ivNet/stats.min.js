var Stats = angular.module('ivNet.Stats', ['ngResource', 'trNgGrid']);

Stats.factory('configuration', function ($resource) {
    return $resource('/api/club/configuration/:id', null,
    {
        'query': { method: 'Get', isArray: true },
    });
});

Stats.factory('stats', function ($resource) {
    return $resource('/api/club/stats/', null,
    {
        'query': { method: 'Get', isArray: false },
    });
});

Stats.controller('StatsController', function($scope, $filter, configuration, stats) {
    init();

    $scope.statsPillClick = function (action) {
        $('table.stats-table').hide();
        $('ul.stats-pills li.pill').removeClass('active');
        $('ul.stats-pills li.' + action).addClass('active');
        $('table.' + action).show();
    };

    $scope.search = function () {
        $('#loading-indicator').show();
        stats.query({ year: $scope.year, team: $scope.team, player: $scope.player },
            function (data) {
                $scope.show_batting_stat_fields = ['Name', 'Innings', 'Runs', 'Highest', 'Dismissals', 'Average'];
                $scope.batting = data.Batting;

                $scope.show_bowling_stat_fields = ['Name', 'Overs', 'Maidens', 'Runs', 'Wickets', 'Economy', 'Strike'];
                $scope.bowling = data.Bowling;

                $scope.show_fielding_stat_fields = ['Name', 'Catches', 'MostCatches', 'Stumpings', 'MostStumpings'];
                $scope.fielding = data.Fielding;

                $('#loading-indicator').hide();
            },
            function (error) {
                $('#loading-indicator').hide();
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });
    };

    function init() {

        $('table.bowling').hide();
        $('table.fielding').hide();
        $('#loading-indicator').show();
        configuration.query({ id: 'stats_selector' },
            function(data) {
                $scope.yearList = filter(data, "year");
                $scope.teamList = filter(data, "team");

                $scope.year = $scope.yearList[$scope.yearList.length - 1].Name;
                $scope.team = "Sat 1st XI";
                $scope.search();                
            },
            function (error) {
                $('#loading-indicator').hide();
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });
    };

    function filter(collection, type)
    {
        var result = new Array();
        var length = collection.length;

        for(var j = 0; j < length; j++)
        {
            if(collection[j].Type == type)
            {
                result.push(collection[j]);
            }
        }

        return result;
    }

});